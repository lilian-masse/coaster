<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Base de données — Coasters</title>

  <!-- Tabulator (table + tri + filtres + pagination) -->
  <link href="https://unpkg.com/tabulator-tables@6.2.5/dist/css/tabulator.min.css" rel="stylesheet">

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    h1 { margin: 0 0 8px; }
    .muted { opacity: 0.75; margin-bottom: 16px; }
    .bar { display: flex; gap: 12px; flex-wrap: wrap; align-items: end; margin: 16px 0; }
    label { display: block; font-size: 14px; margin-bottom: 6px; }
    input, select { padding: 10px 12px; font-size: 14px; min-width: 220px; }
    button { padding: 10px 12px; font-size: 14px; cursor: pointer; }
    #table { margin-top: 12px; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; }
  </style>
</head>
<body>
  <h1>Coasters</h1>
  <div class="muted">
    Recherche globale, filtres par colonne, tri, pagination.
    <span id="count" class="pill">…</span>
  </div>

  <div class="bar">
    <div>
      <label for="q">Recherche (toutes colonnes)</label>
      <input id="q" type="text" placeholder="ex: Intamin, 2005, vitesse..." />
    </div>

    <div>
      <label for="col">Colonne</label>
      <select id="col"></select>
    </div>

    <div>
      <label for="val">Filtre (contient)</label>
      <input id="val" type="text" placeholder="ex: USA" />
    </div>

    <div>
      <button id="clear">Réinitialiser filtres</button>
    </div>
  </div>

  <div id="table"></div>

  <script src="https://unpkg.com/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>
  <script>
    const dataUrl = "./data/coasters_clean.json";

    function toTitle(s){
      return (s || "")
        .replace(/_/g," ")
        .replace(/\b\w/g, c => c.toUpperCase());
    }

    function guessColumns(rows){
      const keys = rows.length ? Object.keys(rows[0]) : [];
      return keys.map(k => ({
        title: toTitle(k),
        field: k,
        headerFilter: true,        // filtre par colonne
        headerFilterLiveFilter: true,
        headerSort: true,
      }));
    }

    (async function init(){
      const res = await fetch(dataUrl);
      if(!res.ok){
        document.body.innerHTML = "<p>Impossible de charger les données. Vérifie le chemin: <code>"+dataUrl+"</code></p>";
        return;
      }
      const rows = await res.json();

      // Table
      const table = new Tabulator("#table", {
        data: rows,
        layout: "fitDataStretch",
        pagination: true,
        paginationSize: 25,
        paginationSizeSelector: [10, 25, 50, 100],
        movableColumns: true,
        columns: guessColumns(rows),
      });

      // compteur
      const countEl = document.getElementById("count");
      const updateCount = () => {
        const n = table.getDataCount("active"); // après filtres
        countEl.textContent = n + " résultat(s)";
      };
      table.on("dataFiltered", updateCount);
      updateCount();

      // UI colonnes
      const colSel = document.getElementById("col");
      const cols = table.getColumns().map(c => c.getField()).filter(Boolean);
      cols.forEach(f => {
        const opt = document.createElement("option");
        opt.value = f;
        opt.textContent = toTitle(f);
        colSel.appendChild(opt);
      });

      // Recherche globale (toutes colonnes): on construit un filtre OR sur chaque champ
      const q = document.getElementById("q");
      q.addEventListener("input", () => {
        const term = q.value.trim().toLowerCase();
        table.clearFilter(true);

        // réappliquer aussi le filtre "colonne contient" si rempli
        applyColumnFilter(false);

        if(!term){
          updateCount();
          return;
        }

        const anyFilters = cols.map(f => {
          return function(data){
            const v = data[f];
            return (v !== null && v !== undefined) &&
              String(v).toLowerCase().includes(term);
          };
        });

        // Tabulator accepte un filtre custom; pour OR, on utilise setFilter avec une fonction
        table.addFilter(function(rowData){
          return anyFilters.some(fn => fn(rowData));
        });

        updateCount();
      });

      // Filtre colonne "contient"
      const val = document.getElementById("val");
      function applyColumnFilter(clearFirst=true){
        const field = colSel.value;
        const term = val.value.trim().toLowerCase();

        if(clearFirst) table.clearFilter(true);

        if(term){
          table.addFilter(function(data){
            const v = data[field];
            return (v !== null && v !== undefined) &&
              String(v).toLowerCase().includes(term);
          });
        }
        updateCount();
      }
      colSel.addEventListener("change", () => applyColumnFilter(true));
      val.addEventListener("input", () => applyColumnFilter(true));

      // reset
      document.getElementById("clear").addEventListener("click", () => {
        q.value = "";
        val.value = "";
        table.clearFilter(true);
        updateCount();
      });
    })();
  </script>
</body>
</html>

<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Coasters — Fiches</title>

<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:24px}
h1{margin:0 0 10px}
.bar{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px;margin-bottom:24px;align-items:start}
label{font-size:13px;margin-bottom:4px;display:block}
input,select,button{padding:8px;font-size:14px;width:100%;box-sizing:border-box}
button{cursor:pointer}

.multibox{border:1px solid #e6e6e6;border-radius:10px;padding:8px;background:#fff}
.multibox .list{max-height:180px;overflow:auto;margin-top:6px}
.multibox label{display:flex;align-items:center;gap:6px;font-size:13px;margin:2px 0}

.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
.card{border:1px solid #e6e6e6;border-radius:14px;padding:14px;background:#fff;box-shadow:0 1px 6px rgba(0,0,0,.04)}
.title{font-weight:750;margin:0 0 6px;font-size:16px}
.sub{opacity:.75;margin:0 0 10px;font-size:13px}
.kv{display:grid;grid-template-columns:110px 1fr;gap:6px 10px;font-size:13px}
.k{opacity:.6}

.range-wrap{position:relative;height:36px}
.range-wrap input{position:absolute;width:100%;pointer-events:none;-webkit-appearance:none;background:none;height:18px;top:9px}
.range-wrap input::-webkit-slider-thumb{pointer-events:auto;-webkit-appearance:none;height:16px;width:16px;border-radius:50%;background:#fff;border:1px solid #999}
.track{position:absolute;left:0;right:0;top:15px;height:6px;background:#eee;border-radius:999px}
.range{position:absolute;top:15px;height:6px;background:#ccc;border-radius:999px}
.range-meta{display:flex;justify-content:space-between;font-size:12px;margin-top:6px}

.empty{padding:18px;border:1px dashed #ccc;border-radius:12px;opacity:.8}
.error{display:none;white-space:pre-wrap;border:1px solid #f0c2c2;background:#fff5f5;color:#7a1f1f;padding:10px;border-radius:10px;margin:10px 0}
</style>
</head>

<body>

<h1>Coasters</h1>

<div class="bar">

<div>
<label>Recherche</label>
<input id="q" placeholder="Rechercher…">
</div>

<div>
<label>Fabricants</label>
<div class="multibox">
<input id="makerSearch" placeholder="Filtrer fabricant…">
<div id="makerList" class="list"></div>
<button id="makerClear">Effacer</button>
</div>
</div>

<div>
<label>Parcs</label>
<div class="multibox">
<input id="parkSearch" placeholder="Filtrer parc…">
<div id="parkList" class="list"></div>
<button id="parkClear">Effacer</button>
</div>
</div>

<div>
<label>Ouverture</label>
<div class="range-wrap">
<div class="track"></div>
<div id="rangeFill" class="range"></div>
<input id="yearMin" type="range">
<input id="yearMax" type="range">
</div>
<div class="range-meta">
<span id="minLabel">—</span>
<span id="maxLabel">—</span>
</div>
</div>

<div>
<label>Tri principal</label>
<select id="sort">
<option value="park_asc" selected>Parc A→Z</option>
<option value="year_asc">Ouverture ↑</option>
<option value="year_desc">Ouverture ↓</option>
</select>
</div>

<div>
<label>Tri secondaire</label>
<select id="sort2">
<option value="year_asc" selected>Ouverture ↑</option>
<option value="year_desc">Ouverture ↓</option>
<option value="park_asc">Parc A→Z</option>
</select>
</div>

<div>
<button id="clear">Réinitialiser</button>
</div>

</div>

<div id="err" class="error"></div>
<div id="grid" class="grid"></div>

<script>
const dataUrl="./data/coasters_clean.json"

const qEl=document.getElementById("q")
const sortSel=document.getElementById("sort")
const sort2Sel=document.getElementById("sort2")
const grid=document.getElementById("grid")
const yearMinEl=document.getElementById("yearMin")
const yearMaxEl=document.getElementById("yearMax")
const fill=document.getElementById("rangeFill")
const minLabel=document.getElementById("minLabel")
const maxLabel=document.getElementById("maxLabel")
const errBox=document.getElementById("err")

const makerList=document.getElementById("makerList")
const parkList=document.getElementById("parkList")
const makerSearch=document.getElementById("makerSearch")
const parkSearch=document.getElementById("parkSearch")

let selectedMakers=new Set()
let selectedParks=new Set()

function showError(msg){errBox.style.display="block";errBox.textContent=msg}
function esc(s){return String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}

function toNumber(v){const n=Number(String(v??"").replace(/[^0-9.\-]/g,""));return Number.isFinite(n)?n:null}
function toYear(v){
const n=toNumber(v)
if(n===null)return null
if(n>=1800&&n<=2200)return Math.trunc(n)
const a=Math.abs(n)
if(a>1e11)return new Date(n).getUTCFullYear()
if(a>1e9)return new Date(n*1000).getUTCFullYear()
return null
}

function sortFamily(v){return v.split("_")[0]}

function sortRows(list,mode1,mode2,f){
function cmp(mode,a,b){
if(mode==="year_desc")return (toYear(b[f.year])??-Infinity)-(toYear(a[f.year])??-Infinity)
if(mode==="year_asc")return (toYear(a[f.year])??Infinity)-(toYear(b[f.year])??Infinity)
if(mode==="park_asc")return String(a[f.park]??"").localeCompare(String(b[f.park]??""),"fr")
return 0
}
return list.slice().sort((a,b)=>{
let c=cmp(mode1,a,b);if(c!==0)return c
c=cmp(mode2,a,b);if(c!==0)return c
return cmp("park_asc",a,b)
})
}

function updateSlider(absMin,absMax){
let min=parseInt(yearMinEl.value)
let max=parseInt(yearMaxEl.value)
if(min>max){[min,max]=[max,min];yearMinEl.value=min;yearMaxEl.value=max}
minLabel.textContent=min
maxLabel.textContent=max
const total=absMax-absMin||1
const left=((min-absMin)/total)*100
const right=((max-absMin)/total)*100
fill.style.left=left+"%"
fill.style.width=(right-left)+"%"
return{min,max}
}

function buildChecklist(container,values,set){
container.innerHTML=values.map(v=>`
<label><input type="checkbox" value="${esc(v)}"> ${esc(v)}</label>
`).join("")
container.querySelectorAll("input").forEach(cb=>{
cb.onchange=()=>{
if(cb.checked)set.add(cb.value)
else set.delete(cb.value)
render()
}
})
}

(async function(){
try{
const res=await fetch(dataUrl)
const rows=await res.json()

if(!rows.length){grid.innerHTML='<div class="empty">Aucune donnée</div>';return}

const keys=Object.keys(rows[0])
const f={
name:keys.find(k=>/nom|name|coaster/i.test(k)),
park:keys.find(k=>/park|parc/i.test(k)),
year:keys.find(k=>/year|annee|ouverture/i.test(k)),
maker:keys.find(k=>/fabricant|manufacturer/i.test(k))
}

let years=rows.map(r=>toYear(r[f.year])).filter(Boolean)
let absMin=Math.min(...years)
let absMax=Math.max(...years)

yearMinEl.min=yearMaxEl.min=absMin
yearMinEl.max=yearMaxEl.max=absMax
yearMinEl.value=absMin
yearMaxEl.value=absMax

const makers=[...new Set(rows.map(r=>r[f.maker]).filter(Boolean))].sort()
const parks=[...new Set(rows.map(r=>r[f.park]).filter(Boolean))].sort()

buildChecklist(makerList,makers,selectedMakers)
buildChecklist(parkList,parks,selectedParks)

makerSearch.oninput=()=>{
const val=makerSearch.value.toLowerCase()
makerList.querySelectorAll("label").forEach(l=>{
l.style.display=l.textContent.toLowerCase().includes(val)?"flex":"none"
})
}
parkSearch.oninput=()=>{
const val=parkSearch.value.toLowerCase()
parkList.querySelectorAll("label").forEach(l=>{
l.style.display=l.textContent.toLowerCase().includes(val)?"flex":"none"
})
}

document.getElementById("makerClear").onclick=()=>{selectedMakers.clear();makerList.querySelectorAll("input").forEach(i=>i.checked=false);render()}
document.getElementById("parkClear").onclick=()=>{selectedParks.clear();parkList.querySelectorAll("input").forEach(i=>i.checked=false);render()}

let prevPrimary=sortSel.value
function updateSecondary(){
const fam=sortFamily(sortSel.value)
for(const o of sort2Sel.options)o.disabled=(sortFamily(o.value)===fam)
if(sortFamily(sort2Sel.value)===fam)sort2Sel.value=prevPrimary
}

sortSel.onchange=()=>{
if(sortFamily(sortSel.value)===sortFamily(sort2Sel.value))
sort2Sel.value=prevPrimary
prevPrimary=sortSel.value
updateSecondary()
render()
}
sort2Sel.onchange=()=>{updateSecondary();render()}

qEl.oninput=render
yearMinEl.oninput=render
yearMaxEl.oninput=render

document.getElementById("clear").onclick=()=>{
qEl.value=""
selectedMakers.clear()
selectedParks.clear()
makerList.querySelectorAll("input").forEach(i=>i.checked=false)
parkList.querySelectorAll("input").forEach(i=>i.checked=false)
yearMinEl.value=absMin
yearMaxEl.value=absMax
sortSel.value="park_asc"
sort2Sel.value="year_asc"
prevPrimary="park_asc"
updateSecondary()
render()
}

updateSecondary()

function render(){
const {min,max}=updateSlider(absMin,absMax)
let filtered=rows.filter(r=>{
if(!r[f.name]||!r[f.name].trim())return false
if(qEl.value&&!Object.values(r).join(" ").toLowerCase().includes(qEl.value.toLowerCase()))return false
if(selectedMakers.size&&!selectedMakers.has(r[f.maker]))return false
if(selectedParks.size&&!selectedParks.has(r[f.park]))return false
const y=toYear(r[f.year])
if(y!==null&&(y<min||y>max))return false
return true
})

filtered=sortRows(filtered,sortSel.value,sort2Sel.value,f)

if(!filtered.length){grid.innerHTML='<div class="empty">Aucun résultat</div>';return}

grid.innerHTML=filtered.map(r=>{
const y=toYear(r[f.year])
return `
<div class="card">
<div class="title">${esc(r[f.name])}</div>
<div class="sub">${esc(r[f.park]||"")}</div>
<div class="kv">
<div class="k">Fabricant</div><div>${esc(r[f.maker]||"")}</div>
<div class="k">Ouverture</div><div>${y??""}</div>
</div>
</div>`
}).join("")
}

render()

}catch(e){showError(e.message)}
})()
</script>

</body>
</html>

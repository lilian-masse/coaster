<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Coasters — Fiches</title>

<style>
body{font-family:system-ui;margin:24px}
h1{margin:0 0 8px}
.bar{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;margin-bottom:20px}
label{font-size:13px;margin-bottom:4px;display:block}
input,select,button{padding:8px;font-size:14px;width:100%;box-sizing:border-box}
button{cursor:pointer}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
.card{border:1px solid #e6e6e6;border-radius:14px;padding:14px;background:#fff}
.title{font-weight:700;margin-bottom:6px}
.sub{opacity:.7;margin-bottom:10px;font-size:13px}
.kv{display:grid;grid-template-columns:110px 1fr;gap:6px 10px;font-size:13px}
.k{opacity:.6}
.range-wrap{position:relative;height:36px}
.range-wrap input{position:absolute;width:100%;pointer-events:none;-webkit-appearance:none;background:none}
.range-wrap input::-webkit-slider-thumb{pointer-events:auto;-webkit-appearance:none;height:16px;width:16px;border-radius:50%;background:#fff;border:1px solid #999}
.track{position:absolute;left:0;right:0;top:15px;height:6px;background:#eee;border-radius:999px}
.range{position:absolute;top:15px;height:6px;background:#ccc;border-radius:999px}
.empty{padding:20px;border:1px dashed #ccc;border-radius:12px}
</style>
</head>

<body>

<h1>Coasters</h1>

<div class="bar">
<div>
<label>Recherche</label>
<input id="q" placeholder="Rechercher…">
</div>

<div>
<label>Tri principal</label>
<select id="sort">
<option value="park_asc" selected>Parc A→Z</option>
<option value="year_asc">Ouverture ↑</option>
<option value="year_desc">Ouverture ↓</option>
</select>
</div>

<div>
<label>Tri secondaire</label>
<select id="sort2">
<option value="year_asc" selected>Ouverture ↑</option>
<option value="year_desc">Ouverture ↓</option>
<option value="park_asc">Parc A→Z</option>
</select>
</div>

<div>
<label>Ouverture</label>
<div class="range-wrap">
<div class="track"></div>
<div id="rangeFill" class="range"></div>
<input id="yearMin" type="range">
<input id="yearMax" type="range">
</div>
</div>

<div style="align-self:end">
<button id="clear">Réinitialiser</button>
</div>
</div>

<div id="grid" class="grid"></div>

<script>
const dataUrl="./data/coasters_clean.json"

const qEl=document.getElementById("q")
const sortSel=document.getElementById("sort")
const sort2Sel=document.getElementById("sort2")
const grid=document.getElementById("grid")
const yearMinEl=document.getElementById("yearMin")
const yearMaxEl=document.getElementById("yearMax")
const fill=document.getElementById("rangeFill")

function norm(v){return String(v??"").trim().toLowerCase()}

function toNumber(v){
const n=Number(String(v??"").replace(/[^0-9.\-]/g,""))
return Number.isFinite(n)?n:null
}

function toYear(v){
const n=toNumber(v)
if(n===null)return null
if(n>=1800&&n<=2200)return Math.trunc(n)

const a=Math.abs(n)

if(a>1e11){
const y=new Date(n).getUTCFullYear()
return Number.isFinite(y)?y:null
}
if(a>1e9){
const y=new Date(n*1000).getUTCFullYear()
return Number.isFinite(y)?y:null
}
return null
}

function sortFamily(v){return v.split("_")[0]}

function sortRows(list,mode1,mode2,f){
function cmp(mode,a,b){
if(mode==="year_desc")return (toYear(b[f.year])??-Infinity)-(toYear(a[f.year])??-Infinity)
if(mode==="year_asc")return (toYear(a[f.year])??Infinity)-(toYear(b[f.year])??Infinity)
if(mode==="park_asc")return String(a[f.park]??"").localeCompare(String(b[f.park]??""),"fr")
return 0
}
return list.slice().sort((a,b)=>{
let c=cmp(mode1,a,b); if(c!==0)return c
c=cmp(mode2,a,b); if(c!==0)return c
return cmp("park_asc",a,b)
})
}

function updateSlider(min,max,absMin,absMax){
if(min>max){[min,max]=[max,min];yearMinEl.value=min;yearMaxEl.value=max}
const total=absMax-absMin||1
const left=((min-absMin)/total)*100
const right=((max-absMin)/total)*100
fill.style.left=left+"%"
fill.style.width=(right-left)+"%"
}

(async function(){
const res=await fetch(dataUrl)
const rows=await res.json()

if(!rows.length){grid.innerHTML='<div class="empty">Aucune donnée</div>';return}

const sample=rows[0]
const f={
name:Object.keys(sample).find(k=>/nom|name|coaster/i.test(k)),
park:Object.keys(sample).find(k=>/park|parc/i.test(k)),
year:Object.keys(sample).find(k=>/year|annee|ouverture/i.test(k)),
maker:Object.keys(sample).find(k=>/fabricant|manufacturer/i.test(k))
}

let years=rows.map(r=>toYear(r[f.year])).filter(y=>y)
let absMin=Math.min(...years)
let absMax=Math.max(...years)

yearMinEl.min=yearMaxEl.min=absMin
yearMinEl.max=yearMaxEl.max=absMax
yearMinEl.value=absMin
yearMaxEl.value=absMax

let prevPrimary=sortSel.value

function updateSecondary(){
const fam=sortFamily(sortSel.value)
for(const o of sort2Sel.options){
o.disabled=(sortFamily(o.value)===fam)
}
if(sortFamily(sort2Sel.value)===fam){
sort2Sel.value=prevPrimary
}
}

sortSel.addEventListener("change",()=>{
if(sortFamily(sortSel.value)===sortFamily(sort2Sel.value)){
sort2Sel.value=prevPrimary
}
prevPrimary=sortSel.value
updateSecondary()
render()
})

sort2Sel.addEventListener("change",()=>{updateSecondary();render()})

qEl.addEventListener("input",render)
yearMinEl.addEventListener("input",render)
yearMaxEl.addEventListener("input",render)

document.getElementById("clear").onclick=()=>{
qEl.value=""
sortSel.value="park_asc"
sort2Sel.value="year_asc"
prevPrimary="park_asc"
yearMinEl.value=absMin
yearMaxEl.value=absMax
updateSecondary()
render()
}

updateSecondary()

function render(){
let min=parseInt(yearMinEl.value)
let max=parseInt(yearMaxEl.value)
updateSlider(min,max,absMin,absMax)

let filtered=rows.filter(r=>{
if(!r[f.name]||!r[f.name].trim())return false
if(qEl.value&&!Object.values(r).join(" ").toLowerCase().includes(qEl.value.toLowerCase()))return false
let y=toYear(r[f.year])
if(y!==null&&(y<min||y>max))return false
return true
})

filtered=sortRows(filtered,sortSel.value,sort2Sel.value,f)

if(!filtered.length){
grid.innerHTML='<div class="empty">Aucun résultat</div>'
return
}

grid.innerHTML=filtered.map(r=>{
const y=toYear(r[f.year])
return `
<div class="card">
<div class="title">${r[f.name]}</div>
<div class="sub">${r[f.park]||""}</div>
<div class="kv">
<div class="k">Fabricant</div><div>${r[f.maker]||""}</div>
<div class="k">Ouverture</div><div>${y??""}</div>
</div>
</div>
`
}).join("")
}

render()

})()
</script>

</body>
</html>

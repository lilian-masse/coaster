<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Coasters — Fiches</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    h1 { margin: 0 0 6px; }
    .muted { opacity: .75; margin-bottom: 16px; line-height: 1.35; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; }

    .bar { display: grid; grid-template-columns: repeat(12, minmax(0, 1fr)); gap: 12px; margin: 16px 0 18px; align-items: start; }
    .field { grid-column: span 3; }
    .field.wide { grid-column: span 6; }
    .field.small { grid-column: span 2; }
    .field.actions { grid-column: span 2; display: flex; gap: 10px; align-items: end; }

    label { display:block; font-size: 14px; margin-bottom: 6px; }
    input, select, button { padding: 10px 12px; font-size: 14px; width: 100%; box-sizing: border-box; }
    button { cursor: pointer; }

    .multibox {
      border: 1px solid #e6e6e6;
      border-radius: 12px;
      padding: 10px;
      background: #fff;
      box-shadow: 0 1px 6px rgba(0,0,0,.03);
    }
    .multibox .search { margin-bottom: 8px; }
    .multibox .list {
      max-height: 220px;
      overflow: auto;
      border-top: 1px solid #eee;
      padding-top: 8px;
    }
    .multibox .row {
      display: flex;
      gap: 8px;
      align-items: center;
      padding: 6px 2px;
      font-size: 13px;
    }
    .multibox .row input { width: auto; }
    .multibox .tools {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .multibox .tools button{
      width: auto;
      padding: 8px 10px;
      font-size: 13px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 14px;
    }
    .card {
      border: 1px solid #e6e6e6;
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 1px 6px rgba(0,0,0,.04);
      background: #fff;
    }
    .title { font-weight: 750; font-size: 16px; margin: 0 0 8px; }
    .sub { opacity: .8; margin: 0 0 10px; font-size: 13px; }
    .kv { display: grid; grid-template-columns: 110px 1fr; gap: 6px 10px; font-size: 13px; }
    .k { opacity: .65; }
    .v { word-break: break-word; }

    .footer {
      margin-top: 18px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
    }
    .empty { padding: 18px; border: 1px dashed #ddd; border-radius: 16px; opacity: .8; }

    @media (max-width: 980px){
      .bar { grid-template-columns: repeat(6, minmax(0, 1fr)); }
      .field { grid-column: span 3; }
      .field.wide { grid-column: span 6; }
      .field.small { grid-column: span 3; }
      .field.actions { grid-column: span 6; }
    }
    @media (max-width: 560px){
      .bar { grid-template-columns: repeat(1, minmax(0, 1fr)); }
      .field, .field.wide, .field.small, .field.actions { grid-column: span 1; }
    }
  </style>
</head>
<body>
  <h1>Coasters</h1>
  <div class="muted">
    Fiches avec recherche + filtres multi (Fabricants / Parcs) + ouverture min/max (année) + tri.
    <span id="count" class="pill">…</span>
  </div>

  <div class="bar">
    <div class="field wide">
      <label for="q">Recherche (tous champs)</label>
      <input id="q" type="text" placeholder="ex: Intamin, Disneyland, wood, vitesse..." />
    </div>

    <div class="field">
      <label>Fabricants (multi)</label>
      <div class="multibox" id="makerBox">
        <input class="search" id="makerSearch" type="text" placeholder="Rechercher un fabricant…" />
        <div class="list" id="makerList"></div>
        <div class="tools">
          <button type="button" id="makerAll">Tout</button>
          <button type="button" id="makerNone">Aucun</button>
        </div>
      </div>
    </div>

    <div class="field">
      <label>Parcs (multi)</label>
      <div class="multibox" id="parkBox">
        <input class="search" id="parkSearch" type="text" placeholder="Rechercher un parc…" />
        <div class="list" id="parkList"></div>
        <div class="tools">
          <button type="button" id="parkAll">Tout</button>
          <button type="button" id="parkNone">Aucun</button>
        </div>
      </div>
    </div>

    <div class="field small">
      <label for="yearMin">Ouverture min (année)</label>
      <input id="yearMin" type="number" inputmode="numeric" placeholder="ex: 1990" />
    </div>

    <div class="field small">
      <label for="yearMax">Ouverture max (année)</label>
      <input id="yearMax" type="number" inputmode="numeric" placeholder="ex: 2010" />
    </div>

    <div class="field small">
      <label for="sort">Tri</label>
      <select id="sort">
        <option value="relevance">Pertinence</option>
        <option value="year_desc">Ouverture ↓</option>
        <option value="year_asc">Ouverture ↑</option>
        <option value="name_asc">Nom A→Z</option>
        <option value="name_desc">Nom Z→A</option>
      </select>
    </div>

    <div class="field actions">
      <button id="clear" type="button">Réinitialiser</button>
      <button id="clearYears" type="button">Effacer années</button>
    </div>
  </div>

  <div id="grid" class="grid"></div>

  <div class="footer">
    <div class="info">
      <span class="pill" id="activeFilters">Filtres: aucun</span>
    </div>
    <div class="info">
      <span id="status" class="pill">Affichage: tous</span>
    </div>
  </div>

  <script>
    // Ton JSON doit être ici dans ton repo :
    // /data/coasters_clean.json
    const dataUrl = "./data/coasters_clean.json";

    // ---- Helpers
    const norm = (v) => String(v ?? "").trim().toLowerCase();

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function titleize(s){
      return (s||"").replace(/_/g," ").replace(/\b\w/g, c => c.toUpperCase());
    }

    function pickField(obj, candidates){
      const keys = Object.keys(obj || {});
      const lower = new Map(keys.map(k => [k.toLowerCase(), k]));
      for (const c of candidates){
        const hit = lower.get(String(c).toLowerCase());
        if (hit) return hit;
      }
      return null;
    }

    function toNumber(v){
      const s = String(v ?? "").trim();
      if(!s) return null;
      const cleaned = s.replace(/[^0-9.\-]/g, "");
      const n = Number(cleaned);
      return Number.isFinite(n) ? n : null;
    }

    // Convertit "Ouverture" en année:
    // - si déjà une année (1800-2200) => retourne cette année
    // - si timestamp ms (ex: 305078400000) => date UTC => année
    // - si timestamp seconds => *1000 => année
    function toYear(v){
      const n = toNumber(v);
      if(n === null) return null;

      if(n >= 1800 && n <= 2200) return Math.trunc(n);

      if(n > 1e11){
        const d = new Date(n);
        const y = d.getUTCFullYear();
        return Number.isFinite(y) ? y : null;
      }

      if(n > 1e9){
        const d = new Date(n * 1000);
        const y = d.getUTCFullYear();
        return Number.isFinite(y) ? y : null;
      }

      return null;
    }

    function matchesQuery(row, q){
      if(!q) return true;
      const text = Object.values(row).map(v => String(v ?? "")).join(" ").toLowerCase();
      return text.includes(q);
    }

    function uniqueSortedLabels(values){
      const cleaned = values.map(v => String(v ?? "").trim()).filter(v => v !== "");
      const uniq = Array.from(new Set(cleaned));
      uniq.sort((a,b)=>a.localeCompare(b, "fr"));
      return uniq;
    }

    function buildChecklist({containerEl, searchEl, allBtn, noneBtn, labels, onChange}){
      // Préserve la sélection même quand on filtre la liste
      const selected = new Set();

      function syncSelectedFromDom(){
        containerEl.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          if(cb.checked) selected.add(cb.value);
          else selected.delete(cb.value);
        });
      }

      function draw(filterText){
        const ft = norm(filterText);
        const shown = labels.filter(l => norm(l).includes(ft));

        containerEl.innerHTML = shown.map(label => {
          const value = norm(label);
          const checked = selected.has(value) ? "checked" : "";
          return `
            <div class="row">
              <input type="checkbox" value="${escapeHtml(value)}" ${checked} />
              <span>${escapeHtml(label)}</span>
            </div>
          `;
        }).join("");

        containerEl.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          cb.addEventListener("change", () => {
            syncSelectedFromDom();
            onChange();
          });
        });
      }

      function setAll(checked){
        if(checked){
          labels.forEach(label => selected.add(norm(label)));
        } else {
          selected.clear();
        }
        draw(searchEl.value);
        onChange();
      }

      searchEl.addEventListener("input", () => draw(searchEl.value));
      allBtn.addEventListener("click", () => setAll(true));
      noneBtn.addEventListener("click", () => setAll(false));

      // API simple pour lire/écrire la sélection
      return {
        draw,
        getSelectedSet: () => new Set(selected),
        clear: () => { selected.clear(); draw(""); },
        selectAll: () => setAll(true),
        selectNone: () => setAll(false),
      };
    }

    function renderCard(row, f){
      // Titre
      let title = f.nameField ? row[f.nameField] : "";
      if(!title){
        const firstNonEmpty = Object.values(row).find(v => String(v??"").trim() !== "");
        title = firstNonEmpty ?? "Fiche";
      }

      // Sous-titre: uniquement le parc (pas l'année)
      const subParts = [];
      if (f.parkField && row[f.parkField]) subParts.push(row[f.parkField]);
      const sub = subParts.join(" • ");

      // Champs affichés
      const show = [];
      const pushIf = (label, field) => {
        if (field && row[field] !== null && row[field] !== undefined && String(row[field]).trim() !== "") {
          show.push([label, row[field]]);
        }
      };

      pushIf("Fabricant", f.makerField);
      pushIf("Parc", f.parkField);

      if (f.yearField){
        const y = toYear(row[f.yearField]);
        if (y !== null) show.push(["Ouverture", y]);
        else pushIf("Ouverture", f.yearField);
      }

      pushIf("Vitesse", f.speedField);
      pushIf("Hauteur", f.heightField);
      pushIf("Longueur", f.lengthField);
      pushIf("Inversions", f.inversionsField);

      // Fallback
      if(show.length === 0){
        Object.entries(row).slice(0, 8).forEach(([k,v]) => {
          if (String(v??"").trim() !== "") show.push([titleize(k), v]);
        });
      }

      return `
        <article class="card">
          <h2 class="title">${escapeHtml(title)}</h2>
          ${sub ? `<p class="sub">${escapeHtml(sub)}</p>` : ""}
          <div class="kv">
            ${show.map(([k,v]) => `
              <div class="k">${escapeHtml(k)}</div>
              <div class="v">${escapeHtml(v)}</div>
            `).join("")}
          </div>
        </article>
      `;
    }

    function sortRows(list, mode, f){
      const getYear = (r) => f.yearField ? toYear(r[f.yearField]) : null;
      const getName = (r) => f.nameField ? String(r[f.nameField] ?? "") : "";

      if(mode === "year_desc"){
        return list.slice().sort((a,b) => (getYear(b) ?? -Infinity) - (getYear(a) ?? -Infinity));
      }
      if(mode === "year_asc"){
        return list.slice().sort((a,b) => (getYear(a) ?? Infinity) - (getYear(b) ?? Infinity));
      }
      if(mode === "name_asc"){
        return list.slice().sort((a,b) => getName(a).localeCompare(getName(b), "fr"));
      }
      if(mode === "name_desc"){
        return list.slice().sort((a,b) => getName(b).localeCompare(getName(a), "fr"));
      }
      return list; // relevance
    }

    // ---- App
    (async function init(){
      const grid = document.getElementById("grid");
      const countEl = document.getElementById("count");
      const activeFiltersEl = document.getElementById("activeFilters");
      const statusEl = document.getElementById("status");

      const qEl = document.getElementById("q");
      const yearMinEl = document.getElementById("yearMin");
      const yearMaxEl = document.getElementById("yearMax");
      const sortSel = document.getElementById("sort");

      const makerSearch = document.getElementById("makerSearch");
      const makerList = document.getElementById("makerList");
      const makerAll = document.getElementById("makerAll");
      const makerNone = document.getElementById("makerNone");

      const parkSearch = document.getElementById("parkSearch");
      const parkList = document.getElementById("parkList");
      const parkAll = document.getElementById("parkAll");
      const parkNone = document.getElementById("parkNone");

      const res = await fetch(dataUrl);
      if(!res.ok){
        grid.innerHTML = `<div class="empty">Impossible de charger <code>${dataUrl}</code>. Vérifie que le fichier existe bien dans <code>/data/</code>.</div>`;
        return;
      }
      const rows = await res.json();
      const sample = rows[0] || {};

      // Champs adaptés à ton JSON FR
      const f = {
        nameField: pickField(sample, ["Nom", "Coaster", "Name", "name", "coaster", "ride", "attraction"]),
        parkField: pickField(sample, ["Parc", "Park", "park", "parc", "location"]),
        makerField: pickField(sample, ["Fabricant", "Fabricant_2", "Constructeur", "Manufacturer", "manufacturer", "maker", "builder"]),
        yearField: pickField(sample
